# torus‑substrate Client Library (`client/`)

> An async Rust library that hides Subxt boilerplate and offers a stable, high‑level API for Torus chain operations.  The CLI (and any other tool) depend on this crate.

---

## 1 · Purpose

* Wrap **runtime‑specific types** generated by Subxt behind ergonomic helper functions.
* Provide **typed calls** for balances, staking, transfers, and faucet operations.
* Serve as the **single code‑gen owner** so the workspace only compiles metadata once.

---

## 2 · Directory layout

```text
client/
├── Cargo.toml          # crate manifest
├── build.rs            # runs subxt-codegen at compile time
└── src/
    ├── lib.rs          # high‑level `Client` + re‑exports
    ├── runtime.rs      # generated → include!(…)
    ├── balances.rs     # pub async fn free_balance(…)
    ├── staking.rs      # stake/unstake helpers
    └── faucet.rs       # dev‑only extrinsics (cfg(feature = "dev-tools"))
```

**Never** edit `runtime.rs` manually – it is fully generated.

---

## 3 · Code‑generation pipeline

`build.rs` executes **at compile time**:

```rust
fn main() {
    subxt_codegen::Command::new()
        // Prefer a pinned metadata blob for reproducibility
        .runtime_metadata_path("../runtime-metadata/torus.scale")
        .dest_path("src/runtime.rs")
        .generate()
        .expect("Subxt code‑gen failed");
}
```

* **Updating**: run `cargo xtask update-metadata --url ws://localhost:9944` to fetch new metadata and commit the blob.
* CI only regenerates when the blob hash changes, keeping diffs clean.

---

## 4 · Public API surface

### 4.1 · `Client` struct

```rust
pub struct Client {
    api: OnlineClient<PolkadotConfig>,
}

impl Client {
    /// Connect to a Torus RPC endpoint.
    pub async fn from_url(url: &str) -> Result<Self> { … }

    /// Split access to domain modules.
    pub fn balances(&self) -> balances::Balances<'_> { … }
    pub fn staking(&self)  -> staking::Staking<'_>  { … }
    #[cfg(feature = "dev-tools")]
    pub fn faucet(&self)   -> faucet::Faucet<'_>    { … }
}
```

### 4.2 · Domain modules

* **balances.rs** – free/staked queries, unified balance struct, utility `format_units`.
* **staking.rs**  – delegate, undelegate, get\_total\_staked.
* **faucet.rs**   – `run_faucet(address)` (feature‑gated).

Each module exposes a light wrapper that owns a `&OnlineClient` reference, so calls chain naturally:

```rust
let (free, staked) = client.balances().show(&account).await?;
```

---

## 5 · Error handling

```rust
pub type Result<T> = anyhow::Result<T>;

#[derive(thiserror::Error, Debug)]
pub enum ClientError {
    #[error("RPC error: {0}")]
    Rpc(#[from] subxt::Error),
    #[error("Cannot find account {0}")]
    UnknownAccount(AccountId32),
    #[error("Insufficient balance (needed {needed}, free {free})")]
    InsufficientBalance { needed: u128, free: u128 },
}
```

`ClientError` is re‑exported at crate root so callers can pattern‑match.

---

## 6 · Feature flags

| Feature     | Effects                                  |
| ----------- | ---------------------------------------- |
| `dev-tools` | Enables faucet module + keyring helpers. |
| *default*   | Production‑safe API surface.             |

---

## 7 · Testing strategy

1. **Unit tests** – Each module has internal tests using \[Subxt mock node] to inject predictable storage values & tx receipts.
2. **Integration tests** – Live node spawned in Docker via \[`testcontainers`]; covers weight/fee calculation.
3. **Fuzzing** – (optional) cargo‑fuzz targets against `balances::format_units`.

`cargo test -p client` must run without a network (mock only) so CI stays fast.

---

## 8 · Updating runtime metadata

1. Run the node you want to target (`cargo run -p node -- --dev`).
2. Fetch & save metadata:

```bash
cargo xtask update-metadata --url ws://127.0.0.1:9944 \
                             --out runtime-metadata/torus.scale
```

3. Commit the new blob and open a PR.  CI will regenerate `runtime.rs` automatically.
4. Bump crate minor version if storage layout changed.

---

## 9 · Versioning policy

* **Patch (0.3.\*)** – bug‑fixes, new helper fns.
* **Minor  (0.\*.Y)** – runtime metadata update, additive API.
* **Major  (X.0.0)** – breaking runtime upgrade or API changes.

The CLI always depends on an exact `={version}` to prevent mismatch.

---

## 10 · Future roadmap

* **Offline signing** helpers (produce raw extrinsic bytes).
* **Multiple runtime support** (mainnet vs testnet metadata side‑by‑side).
* **Caching layer** (optional LRU on storage queries).

Contributions welcome – see `CONTRIBUTING.md` for guidelines.
